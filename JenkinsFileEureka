// ==========================================
// JENKINSFILE PARA EUREKA SERVER CON SYSTEMD
// ==========================================

pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    triggers {
        githubPush()
    }

    options {
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    environment {
        BRANCH_NAME = "${env.GIT_BRANCH?.replaceAll('origin/', '') ?: env.BRANCH_NAME ?: 'dev'}"
        ENV = "${env.BRANCH_NAME == 'main' ? 'prod' : env.BRANCH_NAME}"
        EUREKA_PORT = "${env.BRANCH_NAME == 'main' ? '8761' : env.BRANCH_NAME == 'qa' ? '8762' : '8763'}"
        
        EC2_USER = 'ubuntu'
        EC2_IP_DEV = '35.168.222.61'
        EC2_IP_QA = '54.161.193.236'
        EC2_IP_PROD = '34.227.172.83'
        
        REMOTE_PATH = '/home/ubuntu/eureka-server'
        SSH_KEY = credentials('ssh-key-ec2')
        
        JDK_DIR = "${WORKSPACE}/jdk21"
        JAVA_HOME = "${JDK_DIR}"
        PATH = "${JDK_DIR}/bin:${PATH}"
    }

    stages {
        stage('üéØ Determine Strategy') {
            steps {
                script {
                    echo "üîç [EUREKA] Rama detectada: ${env.BRANCH_NAME}"
                    echo "üåç [EUREKA] Entorno: ${env.ENV}"

                    if (env.BRANCH_NAME == 'dev') {
                        echo "üöÄ [EUREKA] ESTRATEGIA: Deploy autom√°tico a DEV"
                        env.DEPLOY_STRATEGY = 'auto'
                        env.TARGET_ENV = 'dev'
                    } else if (env.BRANCH_NAME == 'qa') {
                        echo "üîÑ [EUREKA] ESTRATEGIA: Deploy autom√°tico a QA"
                        env.DEPLOY_STRATEGY = 'auto'
                        env.TARGET_ENV = 'qa'
                    } else if (env.BRANCH_NAME == 'main') {
                        echo "‚ö†Ô∏è [EUREKA] ESTRATEGIA: Aprobaci√≥n manual + Deploy a PROD"
                        env.DEPLOY_STRATEGY = 'manual-approval'
                        env.TARGET_ENV = 'prod'
                    } else {
                        echo "‚úèÔ∏è [EUREKA] ESTRATEGIA: Solo compilaci√≥n"
                        env.DEPLOY_STRATEGY = 'compile-only'
                        env.TARGET_ENV = 'none'
                    }

                    echo "üéØ [EUREKA] Estrategia: ${env.DEPLOY_STRATEGY}"
                    echo "üéØ [EUREKA] Entorno: ${env.TARGET_ENV}"
                }
            }
        }

        stage('üîß Setup JDK 21') {
            when {
                not { environment name: 'DEPLOY_STRATEGY', value: 'skip' }
            }
            steps {
                echo "üîß [EUREKA] Configurando JDK 21..."
                sh '''
                    mkdir -p ${JDK_DIR}

                    if [ ! -f ${JDK_DIR}/bin/java ]; then
                        echo "üì• [EUREKA] Descargando JDK 21..."
                        wget -q https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.2%2B13/OpenJDK21U-jdk_x64_linux_hotspot_21.0.2_13.tar.gz -O jdk21.tar.gz
                        tar -xzf jdk21.tar.gz -C ${JDK_DIR} --strip-components=1
                        rm jdk21.tar.gz
                        echo "‚úÖ [EUREKA] JDK 21 instalado"
                    else
                        echo "‚úÖ [EUREKA] JDK 21 ya existe"
                    fi

                    echo "‚òï [EUREKA] Java version:"
                    ${JDK_DIR}/bin/java -version
                '''
            }
        }

        stage('üî® Build Eureka Server') {
            when {
                not { environment name: 'DEPLOY_STRATEGY', value: 'skip' }
            }
            steps {
                sh '''
                    export JAVA_HOME=${JDK_DIR}
                    export PATH=${JAVA_HOME}/bin:$PATH

                    echo "üî® [EUREKA] Compilando Eureka Server..."
                    ./mvnw clean package -DskipTests -q

                    if [ -f target/discoveryService-0.0.1-SNAPSHOT.jar ]; then
                        echo "‚úÖ [EUREKA] JAR creado exitosamente"
                        ls -lh target/discoveryService-0.0.1-SNAPSHOT.jar
                    else
                        echo "‚ùå [EUREKA] Error: JAR no fue creado"
                        exit 1
                    fi
                '''
            }
        }

        stage('üß™ Tests') {
            when {
                not { environment name: 'DEPLOY_STRATEGY', value: 'skip' }
            }
            steps {
                sh '''
                    export JAVA_HOME=${JDK_DIR}
                    export PATH=${JAVA_HOME}/bin:$PATH

                    echo "üß™ [EUREKA] Ejecutando tests..."
                    ./mvnw test -q || echo "‚ö†Ô∏è [EUREKA] Tests fallaron, continuando..."
                '''
            }
        }

        stage('‚ö†Ô∏è Production Approval') {
            when {
                environment name: 'DEPLOY_STRATEGY', value: 'manual-approval'
            }
            steps {
                script {
                    echo "üö® [EUREKA] APROBACI√ìN REQUERIDA PARA PRODUCCI√ìN"
                    echo "Servicio: EUREKA SERVER"
                    echo "Entorno: PRODUCCI√ìN"
                    echo "Rama: ${env.BRANCH_NAME}"
                    echo "Build: ${env.BUILD_NUMBER}"

                    timeout(time: 10, unit: 'MINUTES') {
                        def approved = input(
                            message: 'üö® ¬øAprobar deploy de EUREKA SERVER a PRODUCCI√ìN?',
                            ok: '‚úÖ Aprobar',
                            parameters: [
                                choice(
                                    name: 'ACTION',
                                    choices: ['Aprobar', 'Rechazar'],
                                    description: 'Selecciona la acci√≥n'
                                )
                            ]
                        )

                        if (approved != 'Aprobar') {
                            error("‚ùå [EUREKA] Deploy a producci√≥n rechazado")
                        }

                        echo "‚úÖ [EUREKA] Deploy a producci√≥n APROBADO"
                    }
                }
            }
        }

        stage('üöÄ Deploy Eureka Server with Systemd') {
            when {
                anyOf {
                    environment name: 'DEPLOY_STRATEGY', value: 'auto'
                    environment name: 'DEPLOY_STRATEGY', value: 'manual-approval'
                }
            }
            steps {
                script {
                    def EC2_IP = ''

                    if (env.TARGET_ENV == 'prod') {
                        EC2_IP = env.EC2_IP_PROD
                    } else if (env.TARGET_ENV == 'qa') {
                        EC2_IP = env.EC2_IP_QA
                    } else {
                        EC2_IP = env.EC2_IP_DEV
                    }

                    echo "üöÄ [EUREKA] Desplegando en ${env.TARGET_ENV.toUpperCase()} (${EC2_IP})"

                    // 1. Preparar servidor e instalar dependencias
                    sh """
                    echo "üîß [EUREKA] Preparando servidor..."
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${EC2_USER}@${EC2_IP} '
                        # Crear directorios
                        sudo mkdir -p ${REMOTE_PATH}
                        sudo chown -R ubuntu:ubuntu ${REMOTE_PATH}

                        # Instalar herramientas b√°sicas
                        which curl > /dev/null || sudo apt-get update -qq && sudo apt-get install -y curl
                        which netstat > /dev/null || sudo apt-get install -y net-tools

                        # Instalar Java si no existe
                        if ! which java > /dev/null; then
                            echo "‚òï [EUREKA] Instalando Java..."
                            sudo apt-get update -qq && sudo apt-get install -y openjdk-21-jre-headless
                        fi

                        echo "‚úÖ [EUREKA] Servidor preparado"
                    '
                    """

                    // 2. Detener servicio existente si existe
                    sh """
                    echo "üõë [EUREKA] Deteniendo servicio existente..."
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        if sudo systemctl is-active --quiet eureka-server.service; then
                            echo "üõë Deteniendo servicio eureka-server..."
                            sudo systemctl stop eureka-server.service
                            sleep 5
                        else
                            echo "‚ÑπÔ∏è Servicio eureka-server no est√° corriendo"
                        fi
                    ' || echo "‚ö†Ô∏è [EUREKA] No hay servicio previo o error al detener"
                    """

                    // 3. Copiar JAR
                    sh """
                    echo "üì¶ [EUREKA] Copiando JAR..."
                    scp -i \$SSH_KEY -o StrictHostKeyChecking=no target/discoveryService-0.0.1-SNAPSHOT.jar ${EC2_USER}@${EC2_IP}:${REMOTE_PATH}/
                    echo "‚úÖ [EUREKA] JAR copiado"
                    """

                    // 4. Crear archivo de servicio systemd
                    def systemdService = """[Unit]
Description=Spring Boot Eureka Discovery Server
After=network.target
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=${REMOTE_PATH}
ExecStart=/usr/bin/java -jar ${REMOTE_PATH}/discoveryService-0.0.1-SNAPSHOT.jar \\
    --spring.profiles.active=${ENV} \\
    --server.port=${EUREKA_PORT} \\
    --logging.level.root=INFO \\
    --logging.level.com.netflix.eureka=DEBUG \\
    --logging.file.name=${REMOTE_PATH}/eureka.log

# Configuraci√≥n de reinicio
Restart=on-failure
RestartSec=10
SuccessExitStatus=143

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=eureka-server

# Seguridad
NoNewPrivileges=true
PrivateTmp=true

# Variables de entorno
Environment=JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
Environment=SPRING_PROFILES_ACTIVE=${ENV}

[Install]
WantedBy=multi-user.target"""

                    // 5. Configurar servicio systemd
                    sh """
                    echo "‚öôÔ∏è [EUREKA] Configurando servicio systemd..."
                    
                    # Crear archivo de servicio
                    echo '${systemdService}' | ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} 'sudo tee /etc/systemd/system/eureka-server.service > /dev/null'
                    
                    # Configurar systemd
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        # Recargar configuraci√≥n
                        sudo systemctl daemon-reload
                        
                        # Habilitar servicio para auto-inicio
                        sudo systemctl enable eureka-server.service
                        
                        echo "‚úÖ [EUREKA] Servicio systemd configurado"
                    '
                    """

                    // 6. Iniciar servicio
                    sh """
                    echo "üöÄ [EUREKA] Iniciando servicio..."
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        # Iniciar servicio
                        sudo systemctl start eureka-server.service
                        
                        # Esperar un momento
                        sleep 5
                        
                        # Verificar estado
                        if sudo systemctl is-active --quiet eureka-server.service; then
                            echo "‚úÖ [EUREKA] Servicio iniciado correctamente"
                            sudo systemctl status eureka-server.service --no-pager -l
                        else
                            echo "‚ùå [EUREKA] Error al iniciar servicio"
                            sudo systemctl status eureka-server.service --no-pager -l
                            sudo journalctl -u eureka-server.service --since \"5 minutes ago\" --no-pager
                            exit 1
                        fi
                    '
                    """

                    echo "‚úÖ [EUREKA] Deploy completado en ${env.TARGET_ENV.toUpperCase()}!"
                }
            }
        }

        stage('üîç Verification') {
            when {
                anyOf {
                    environment name: 'DEPLOY_STRATEGY', value: 'auto'
                    environment name: 'DEPLOY_STRATEGY', value: 'manual-approval'
                }
            }
            steps {
                script {
                    def EC2_IP = ''

                    if (env.TARGET_ENV == 'prod') {
                        EC2_IP = env.EC2_IP_PROD
                    } else if (env.TARGET_ENV == 'qa') {
                        EC2_IP = env.EC2_IP_QA
                    } else {
                        EC2_IP = env.EC2_IP_DEV
                    }

                    echo "üîç [EUREKA] Verificando deploy en ${env.TARGET_ENV.toUpperCase()}..."

                    // Esperar que el servicio est√© listo
                    sh "sleep 30"

                    // Verificar health
                    sh """
                    echo "üè• [EUREKA] Verificando servicio..."

                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        # Verificar estado del servicio
                        echo "üìä Estado del servicio:"
                        sudo systemctl status eureka-server.service --no-pager
                        
                        # Verificar que est√© habilitado para auto-inicio
                        if sudo systemctl is-enabled eureka-server.service; then
                            echo "‚úÖ [EUREKA] Servicio habilitado para auto-inicio"
                        else
                            echo "‚ö†Ô∏è [EUREKA] Servicio NO habilitado para auto-inicio"
                        fi
                        
                        # Verificar health endpoint
                        echo "üè• Verificando health endpoint..."
                        for i in {1..10}; do
                            if curl -f http://localhost:${EUREKA_PORT}/actuator/health 2>/dev/null; then
                                echo "‚úÖ [EUREKA] Health Check: PASSED"
                                break
                            fi
                            echo "‚è≥ [EUREKA] Esperando health endpoint... (\$i/10)"
                            sleep 10
                        done
                        
                        # Verificar Eureka Dashboard
                        if curl -f http://localhost:${EUREKA_PORT}/ 2>/dev/null; then
                            echo "‚úÖ [EUREKA] Dashboard: ACCESSIBLE"
                        else
                            echo "‚ö†Ô∏è [EUREKA] Dashboard: NOT_ACCESSIBLE"
                        fi
                        
                        # Mostrar √∫ltimos logs
                        echo "üìÑ √öltimos logs del servicio:"
                        sudo journalctl -u eureka-server.service --since \"2 minutes ago\" --no-pager | tail -20
                    '
                    """

                    echo "‚úÖ [EUREKA] Verificaci√≥n completada"
                }
            }
        }
    }

    post {
        success {
            script {
                if (env.DEPLOY_STRATEGY && env.DEPLOY_STRATEGY != 'compile-only') {
                    def EC2_IP = ''
                    if (env.TARGET_ENV == 'prod') {
                        EC2_IP = env.EC2_IP_PROD
                    } else if (env.TARGET_ENV == 'qa') {
                        EC2_IP = env.EC2_IP_QA
                    } else {
                        EC2_IP = env.EC2_IP_DEV
                    }

                    echo """
üéâ [EUREKA] ¬°DEPLOY EXITOSO EN ${env.TARGET_ENV.toUpperCase()}!

üìã Servicio desplegado:
   ‚Ä¢ Eureka Server: Puerto ${EUREKA_PORT}
   ‚Ä¢ Servidor: ${EC2_IP}
   ‚Ä¢ Servicio systemd: eureka-server.service

üåê URLs de verificaci√≥n:
   ‚Ä¢ Health: http://${EC2_IP}:${EUREKA_PORT}/actuator/health
   ‚Ä¢ Dashboard: http://${EC2_IP}:${EUREKA_PORT}/

üõ†Ô∏è Comandos √∫tiles (systemd):
   ‚Ä¢ Estado: sudo systemctl status eureka-server.service
   ‚Ä¢ Logs: sudo journalctl -u eureka-server.service -f
   ‚Ä¢ Reiniciar: sudo systemctl restart eureka-server.service
   ‚Ä¢ Detener: sudo systemctl stop eureka-server.service
   ‚Ä¢ Iniciar: sudo systemctl start eureka-server.service

‚úÖ El servicio se iniciar√° autom√°ticamente al reiniciar el servidor
"""
                } else {
                    echo "‚úÖ [EUREKA] Compilaci√≥n exitosa - Rama: ${env.BRANCH_NAME}"
                }
            }
        }

        failure {
            echo """
‚ùå [EUREKA] PIPELINE FALLIDO

üîç Informaci√≥n:
   ‚Ä¢ Servicio: EUREKA SERVER
   ‚Ä¢ Rama: ${env.BRANCH_NAME}
   ‚Ä¢ Estrategia: ${env.DEPLOY_STRATEGY ?: 'N/A'}
   ‚Ä¢ Build: ${env.BUILD_NUMBER}
   ‚Ä¢ URL: ${env.BUILD_URL}

üõ†Ô∏è Para debugging:
   ‚Ä¢ sudo systemctl status eureka-server.service
   ‚Ä¢ sudo journalctl -u eureka-server.service
"""
        }

        cleanup {
            sh '''
                rm -rf jdk21.tar.gz || true
                echo "‚úÖ [EUREKA] Limpieza completada"
            '''
        }
    }
}
